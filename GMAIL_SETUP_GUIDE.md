# Gmail SMTP Configuration Guide

## Overview
This guide explains how to configure Glass Market to send emails using Gmail's SMTP server.

## Prerequisites

1. **Gmail Account** with 2-Factor Authentication enabled
2. **Google App Password** (16-character password generated by Google)
3. **PHP** with `openssl` extension enabled

## Step-by-Step Setup

### 1. Enable 2-Factor Authentication in Gmail

1. Go to [Google Account Security](https://myaccount.google.com/security)
2. Under "Signing in to Google", click on "2-Step Verification"
3. Follow the prompts to enable 2FA

### 2. Generate App Password

1. Go to [Google Account Security](https://myaccount.google.com/security)
2. Under "Signing in to Google", click on "App passwords"
3. Select "Mail" and "Other (Custom name)"
4. Enter "Glass Market" as the name
5. Click "Generate"
6. **Copy the 16-character password** (save it securely)

### 3. Update .env Configuration

Open `.env` file and update the following settings:

```env
# Gmail SMTP Configuration
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD="${GOOGLE_APP_SECRET}"
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="noreply@glassmarket.com"
MAIL_FROM_NAME="Glass Market"

# Google App Password (16 characters, no spaces)
GOOGLE_APP_SECRET="abcd efgh ijkl mnop"
GMAIL_FROM_EMAIL="your-email@gmail.com"
```

**Replace:**
- `your-email@gmail.com` with your actual Gmail address
- `abcd efgh ijkl mnop` with your generated App Password

### 4. Test Email Configuration

Run the test script from command line:

```bash
php test-email.php
```

Or access via browser:
```
http://localhost/glass-market/test-email.php
```

## Email Service Features

### Current Implementation

The `EmailService` class supports three sending methods:

1. **PHPMailer** (recommended) - Full-featured SMTP library
2. **Socket SMTP** (fallback) - Custom implementation using PHP sockets
3. **PHP mail()** (legacy) - Basic mail function

### Available Email Templates

1. **Welcome Email** - Sent when users register
2. **New Listing Notification** - Sent when new products are posted
3. **Verification Email** - For email verification (future)
4. **Password Reset** - For password recovery (future)

## Gmail SMTP Settings

| Setting | Value |
|---------|-------|
| Host | smtp.gmail.com |
| Port | 587 (TLS) or 465 (SSL) |
| Encryption | TLS (recommended) |
| Authentication | Required |
| Username | Your Gmail address |
| Password | App Password (16 characters) |

## Sending Limits

Gmail has daily sending limits for regular accounts:

- **Free Gmail:** 500 emails per day
- **Google Workspace:** 2,000 emails per day

For higher volume, consider using:
- **SendGrid** (free tier: 100 emails/day)
- **Mailgun** (free tier: 5,000 emails/month)
- **Amazon SES** (pay as you go)

## Troubleshooting

### Emails Not Sending

1. **Check App Password:**
   - Must be 16 characters
   - No spaces in the password
   - Generated specifically for "Mail" app type

2. **Verify 2FA is Enabled:**
   - App passwords only work with 2FA enabled

3. **Check PHP OpenSSL:**
   ```bash
   php -m | grep openssl
   ```

4. **Review Error Logs:**
   - Check `storage/logs/laravel.log`
   - Check PHP error log
   - Enable debug mode in `.env`: `APP_DEBUG=true`

### Emails Going to Spam

1. **Set proper FROM address:**
   - Use your Gmail address or verified domain
   - Match MAIL_USERNAME and GMAIL_FROM_EMAIL

2. **Add SPF Record** (if using custom domain):
   ```
   v=spf1 include:_spf.google.com ~all
   ```

3. **Test Email Score:**
   - Use [Mail Tester](https://www.mail-tester.com)

### Connection Timeout

1. **Check firewall settings:**
   - Allow outbound connections on port 587
   
2. **Try alternative port:**
   - Change `MAIL_PORT=465` and `MAIL_ENCRYPTION=ssl`

3. **Disable antivirus email protection temporarily**

## Security Best Practices

1. **Never commit .env file** to version control
2. **Use App Passwords** instead of account password
3. **Rotate passwords** regularly
4. **Monitor account activity** in Google Security settings
5. **Use environment variables** for sensitive data

## Alternative: Install PHPMailer (Recommended)

For better reliability, install PHPMailer:

```bash
composer require phpmailer/phpmailer
```

The `EmailService` class will automatically detect and use PHPMailer if available.

## Code Examples

### Send Welcome Email

```php
require_once 'app/Services/EmailService.php';

$emailService = new EmailService();
$result = $emailService->sendWelcomeEmail(
    'user@example.com',
    'John Doe'
);
```

### Send Listing Notification

```php
$listing = [
    'title' => 'Clear Float Glass',
    'glass_type' => 'Float Glass',
    'quantity' => '1000 kg',
    'location' => 'Amsterdam'
];

$emailService->sendNewListingNotification(
    'buyer@example.com',
    'Jane Smith',
    $listing
);
```

## Email Logging

All emails are logged in the `email_logs` table with:
- Recipient
- Subject
- Status (sent/failed)
- Timestamp
- Error message (if failed)

Query recent emails:
```sql
SELECT * FROM email_logs 
ORDER BY sent_at DESC 
LIMIT 10;
```

## Support

For issues with:
- **Gmail/Google:** [Google Support](https://support.google.com/mail)
- **App Passwords:** [App Password Help](https://support.google.com/accounts/answer/185833)
- **Glass Market:** Check application logs or contact admin

## Next Steps

After configuring Gmail:

1. ✅ Test email sending with `test-email.php`
2. ✅ Verify emails arrive in inbox (check spam)
3. ✅ Register a test user to verify welcome emails
4. ✅ Create a test listing to verify notifications
5. ✅ Monitor email logs for any failures
6. ⏳ Consider PHPMailer for production use
7. ⏳ Set up email queue for high volume
8. ⏳ Add email templates for other notifications

## Additional Resources

- [Gmail SMTP Settings](https://support.google.com/mail/answer/7126229)
- [PHPMailer Documentation](https://github.com/PHPMailer/PHPMailer)
- [Email Best Practices](https://developers.google.com/gmail/api/guides/sending)
